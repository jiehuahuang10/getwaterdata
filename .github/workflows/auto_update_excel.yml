name: å®šæ—¶æ›´æ–°Excelæ•°æ®

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸‹åˆ6ç‚¹ï¼ˆUTCæ—¶é—´ä¸Šåˆ10ç‚¹ï¼‰
    - cron: '0 10 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-excel:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“… è·å–å½“å‰æ—¥æœŸ
        id: date
        run: |
          # è·å–æ˜¨å¤©çš„æ—¥æœŸï¼ˆå› ä¸ºé€šå¸¸æ˜¯æ›´æ–°æ˜¨å¤©çš„æ•°æ®ï¼‰
          echo "target_date=$(date -d '1 day ago' '+%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "current_time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      
      - name: ğŸ”„ è§¦å‘Renderè‡ªåŠ¨æ›´æ–°
        run: |
          echo "ğŸ• æ‰§è¡Œæ—¶é—´: ${{ steps.date.outputs.current_time }}"
          echo "ğŸ“… ç›®æ ‡æ—¥æœŸ: ${{ steps.date.outputs.target_date }}"
          
          response=$(curl -s -X POST \
            https://getwaterdata.onrender.com/execute_auto_update \
            -H "Content-Type: application/json" \
            -d "{\"date\": \"${{ steps.date.outputs.target_date }}\"}" \
            -w "\n%{http_code}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ğŸ“¡ HTTPçŠ¶æ€ç : $http_code"
          echo "ğŸ“„ å“åº”å†…å®¹: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Excelæ›´æ–°ä»»åŠ¡å·²æˆåŠŸè§¦å‘"
            
            # æ£€æŸ¥å“åº”ä¸­çš„successå­—æ®µ
            success=$(echo "$body" | jq -r '.success // empty')
            if [ "$success" = "true" ]; then
              echo "ğŸ‰ Excelæ–‡ä»¶æ›´æ–°æˆåŠŸï¼"
            else
              echo "âš ï¸ ä»»åŠ¡è§¦å‘æˆåŠŸä½†æ‰§è¡Œå¯èƒ½æœ‰é—®é¢˜"
              echo "$body" | jq '.'
            fi
          else
            echo "âŒ è¯·æ±‚å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $http_code"
            echo "$body"
            exit 1
          fi
      
      - name: ğŸ“Š å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: always()
        run: |
          echo "ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
          echo "å¦‚éœ€é‚®ä»¶é€šçŸ¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œé…ç½®"

