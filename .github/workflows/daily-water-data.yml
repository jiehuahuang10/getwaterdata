name: æ¯æ—¥æ°´åŠ¡æ•°æ®è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    # æ¯å¤©ä¸‹åˆ6ç‚¹æ‰§è¡Œ (UTCæ—¶é—´10:00 = åŒ—äº¬æ—¶é—´18:00)
    - cron: '0 10 * * *'
    # æ¯å¤©ä¸‹åˆ6:30å¤‡ä»½æ‰§è¡Œï¼ˆé˜²æ­¢ç¬¬ä¸€æ¬¡å¤±è´¥ï¼‰
    - cron: '30 10 * * *'
    # æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹ä¿æŒæ´»è·ƒ (UTCæ—¶é—´1:00 = åŒ—äº¬æ—¶é—´9:00)
    - cron: '0 1 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-water-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®30åˆ†é’Ÿè¶…æ—¶
    permissions:
      contents: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests beautifulsoup4 openpyxl
    
    - name: åˆ›å»ºé…ç½®æ–‡ä»¶
      run: |
        echo "LOGIN_URL=${{ secrets.LOGIN_URL }}" > config.env
        echo "USERNAME=${{ secrets.USERNAME }}" >> config.env
        echo "PASSWORD=${{ secrets.PASSWORD }}" >> config.env
        echo "REPORT_URL=${{ secrets.REPORT_URL }}" >> config.env
    
    - name: æ‰§è¡Œæ°´åŠ¡æ•°æ®æ›´æ–°ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
      id: update_data
      run: |
        MAX_RETRIES=3
        RETRY_COUNT=0
        SUCCESS=false
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
          echo "ğŸ”„ å°è¯•æ‰§è¡Œï¼ˆç¬¬ $((RETRY_COUNT + 1)) æ¬¡ï¼‰..."
          
          if python github_automation.py; then
            echo "âœ… æ‰§è¡ŒæˆåŠŸï¼"
            SUCCESS=true
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "âŒ æ‰§è¡Œå¤±è´¥ï¼Œç­‰å¾…30ç§’åé‡è¯•..."
              sleep 30
            else
              echo "âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ‰§è¡Œå¤±è´¥"
              exit 1
            fi
          fi
        done
      env:
        TZ: Asia/Shanghai
        LOGIN_URL: ${{ secrets.LOGIN_URL }}
        USERNAME: ${{ secrets.USERNAME }}
        PASSWORD: ${{ secrets.PASSWORD }}
        REPORT_URL: ${{ secrets.REPORT_URL }}
      continue-on-error: true
    
    - name: æ£€æŸ¥æ‰§è¡Œç»“æœ
      id: check_result
      run: |
        if [ -f "last_execution_summary.json" ]; then
          echo "æ‰§è¡Œæ‘˜è¦å­˜åœ¨"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "æ‰§è¡Œæ‘˜è¦ä¸å­˜åœ¨ï¼Œå¯èƒ½æ‰§è¡Œå¤±è´¥"
          echo "success=false" >> $GITHUB_OUTPUT
        fi
    
    # é£ä¹¦åŒæ­¥åŠŸèƒ½å·²æš‚æ—¶ç¦ç”¨
    # åŸå› ï¼šGitHub Actions æœåŠ¡å™¨åœ¨æµ·å¤–ï¼Œæ— æ³•è®¿é—®é£ä¹¦ API
    # å¦‚éœ€å¯ç”¨ï¼Œè¯·åœ¨å›½å†…æœåŠ¡å™¨ç¯å¢ƒè¿è¡Œ
    # - name: åŒæ­¥åˆ°é£ä¹¦äº‘ç©ºé—´
    #   if: steps.check_result.outputs.success == 'true'
    #   run: |
    #     echo "=================================="
    #     echo "ğŸ“¤ å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°é£ä¹¦äº‘ç©ºé—´..."
    #     echo "=================================="
    #     python feishu_sync.py
    #   env:
    #     FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
    #     FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
    #     FEISHU_FOLDER_TOKEN: ${{ secrets.FEISHU_FOLDER_TOKEN }}
    #   continue-on-error: true
    
    - name: æäº¤æ›´æ–°çš„Excelæ–‡ä»¶
      if: steps.check_result.outputs.success == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add excel_exports/çŸ³æ»©ä¾›æ°´æœåŠ¡éƒ¨æ¯æ—¥æ€»ä¾›æ°´æƒ…å†µ.xlsx
        git add *.json
        git add last_execution_summary.json
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶æ›´æ”¹"
        else
          git commit -m "è‡ªåŠ¨æ›´æ–°æ°´åŠ¡æ•°æ® - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
    
    - name: åˆ›å»ºæ‰§è¡ŒçŠ¶æ€å¾½ç« 
      if: always()
      run: |
        # åˆ›å»ºæ‰§è¡ŒçŠ¶æ€æ–‡ä»¶
        if [ "${{ steps.check_result.outputs.success }}" == "true" ]; then
          echo "âœ… æœ€åæ‰§è¡ŒæˆåŠŸ: $(date +'%Y-%m-%d %H:%M:%S')" > execution_status.md
        else
          echo "âŒ æœ€åæ‰§è¡Œå¤±è´¥: $(date +'%Y-%m-%d %H:%M:%S')" > execution_status.md
        fi
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add execution_status.md
        git commit -m "æ›´æ–°æ‰§è¡ŒçŠ¶æ€ - $(date +'%Y-%m-%d %H:%M:%S')" || true
        git push || true
    
    - name: éªŒè¯Excelæ–‡ä»¶æ›´æ–°
      if: steps.check_result.outputs.success == 'true'
      run: |
        EXCEL_FILE="excel_exports/çŸ³æ»©ä¾›æ°´æœåŠ¡éƒ¨æ¯æ—¥æ€»ä¾›æ°´æƒ…å†µ.xlsx"
        
        if [ -f "$EXCEL_FILE" ]; then
          FILE_SIZE=$(stat -f%z "$EXCEL_FILE" 2>/dev/null || stat -c%s "$EXCEL_FILE" 2>/dev/null)
          LAST_MODIFIED=$(stat -f%Sm "$EXCEL_FILE" 2>/dev/null || stat -c%y "$EXCEL_FILE" 2>/dev/null)
          
          echo "âœ… Excelæ–‡ä»¶å­˜åœ¨"
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          echo "ğŸ•’ æœ€åä¿®æ”¹: $LAST_MODIFIED"
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦åˆç†ï¼ˆåº”è¯¥å¤§äº100KBï¼‰
          if [ "$FILE_SIZE" -lt 100000 ]; then
            echo "âš ï¸ è­¦å‘Š: Excelæ–‡ä»¶å¤§å°å¼‚å¸¸å°ï¼Œå¯èƒ½æœªæ­£ç¡®æ›´æ–°"
          fi
        else
          echo "âŒ é”™è¯¯: Excelæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
    
    - name: å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "=================================="
        echo "âŒ GitHub Actionsæ‰§è¡Œå¤±è´¥"
        echo "=================================="
        echo "å¤±è´¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "å¤±è´¥åŸå› : è¯·æŸ¥çœ‹ä¸Šé¢çš„æ—¥å¿—è¯¦æƒ…"
        echo "æ—¥å¿—é“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ“‹ å¯èƒ½çš„åŸå› :"
        echo "  1. ç½‘ç»œè¿æ¥é—®é¢˜"
        echo "  2. ç™»å½•å‡­è¯è¿‡æœŸ"
        echo "  3. æ°´åŠ¡ç³»ç»Ÿç»´æŠ¤ä¸­"
        echo "  4. Excelæ–‡ä»¶æŸå"
        echo ""
        echo "ğŸ”§ å»ºè®®æ“ä½œ:"
        echo "  1. æ£€æŸ¥GitHub Secretsé…ç½®"
        echo "  2. æ‰‹åŠ¨è§¦å‘workflow_dispatchæµ‹è¯•"
        echo "  3. æŸ¥çœ‹kdocs-maintenanceæ˜¯å¦æ­£å¸¸è¿è¡Œ"
        echo "=================================="
    
    - name: æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo "=================================="
        echo "âœ… GitHub Actionsæ‰§è¡ŒæˆåŠŸ"
        echo "=================================="
        echo "æ‰§è¡Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "æ›´æ–°æ—¥æœŸ: $(date -d yesterday +'%Y-%m-%d' 2>/dev/null || date -v-1d +'%Y-%m-%d' 2>/dev/null)"
        echo ""
        echo "âœ… Excelæ–‡ä»¶å·²æˆåŠŸæ›´æ–°å¹¶æ¨é€åˆ°GitHub"
        echo ""
        echo "ğŸ“Š ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´: æ˜å¤©ä¸‹åˆ6:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰"
        echo "ğŸ”— GitHubæŸ¥çœ‹: https://github.com/jiehuahuang10/getwaterdata"
        echo "=================================="
