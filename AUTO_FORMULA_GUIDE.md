# 自动公式和模拟数据功能说明

## 🎉 新功能已启用！

现在当您点击"添加下一个月"或"添加下两个月"按钮时，系统会**自动**：

1. ✅ 生成监控点模拟数据
2. ✅ 添加供水量计算公式
3. ✅ 添加损耗水量计算公式
4. ✅ 添加水损耗率计算公式
5. ✅ 添加合计行的SUM公式

---

## 📊 数据结构

每个月度统计表包含**3行数据** + **1行合计**：

### 第1行（总表）
- **监控点数据**：
  - B列（荔新大道）: 4,200,000 - 4,300,000
  - C列（宁西总表）: 3,400,000 - 3,500,000
  - D列（如丰大道）: 250,000 - 260,000

- **公式**：
  ```excel
  G列（供水量） = B-C-D
  H列（售水量） = 200,000 - 210,000（模拟数据）
  I列（损耗水量）= G-H
  J列（水损耗率）= I/G
  ```

### 第2行（总表）
- **监控点数据**：
  - D列（如丰大道）: 250,000 - 260,000
  - E列（新城大道医院NB）: 500,000 - 510,000
  - F列（三棵竹）: 260,000 - 270,000

- **公式**：
  ```excel
  G列（供水量） = D+E-F
  H列（售水量） = 500,000 - 510,000（模拟数据）
  I列（损耗水量）= G-H
  J列（水损耗率）= I/G
  ```

### 第3行（分表）
- **监控点数据**：
  - F列（三棵竹）: 260,000 - 270,000

- **公式**：
  ```excel
  G列（供水量） = F
  H列（售水量） = 290,000 - 295,000（模拟数据）
  I列（损耗水量）= G-H
  J列（水损耗率）= I/G
  ```

### 合计行
- **公式**：
  ```excel
  G列（供水量总计） = SUM(G数据行1:G数据行3)
  H列（售水量总计） = SUM(H数据行1:H数据行3)
  I列（损耗水量总计）= G合计 - H合计
  J列（水损耗率总计）= I合计 / G合计
  ```

---

## 🔄 计算逻辑

### 供水量计算（3种类型）

1. **类型1（差值法）**: `供水量 = 荔新大道 - 宁西总表 - 如丰大道`
   - 适用于：大区域减去子区域的供水量
   - 公式：`=B行-C行-D行`

2. **类型2（加减法）**: `供水量 = 如丰大道 + 新城大道医院NB - 三棵竹`
   - 适用于：两个供水源相加，减去一个分表
   - 公式：`=D行+E行-F行`

3. **类型3（直接引用）**: `供水量 = 三棵竹`
   - 适用于：分表独立计量
   - 公式：`=F行`

### 损耗水量计算

```
损耗水量 = 供水量 - 售水量
公式: =G行-H行
```

### 水损耗率计算

```
水损耗率 = 损耗水量 / 供水量
公式: =I行/G行
显示格式: 百分比（如 0.25 显示为 25.00%）
```

---

## 🎯 使用方法

### 步骤1: 打开网页
访问: http://localhost:5001

### 步骤2: 点击按钮
- **添加下一个月**: 在最后一个月的基础上 +1 个月
- **添加下两个月**: 在最后一个月的基础上 +2 个月

### 步骤3: 自动完成
系统会自动：
1. 识别最后一个月份（例如：2025年9月）
2. 计算目标月份（例如：2025年10月）
3. 添加月份标题和表头
4. **生成3行模拟数据**（包含公式）
5. **添加合计行**（包含SUM公式）
6. 保存Excel文件

### 步骤4: 查看结果
打开 `excel_exports/石滩区分区计量.xlsx`，查看新添加的统计表。

---

## 📈 示例数据

以下是一个自动生成的示例：

### 2025年12月 统计表

| 类型 | 荔新大道 | 宁西总表 | 如丰大道 | 新城大道医院NB | 三棵竹 | **供水量** | 售水量 | **损耗水量** | **水损耗率** |
|------|---------|---------|---------|--------------|-------|-----------|-------|------------|------------|
| 总表 | 4,264,205 | 3,457,264 | 253,250 | 0 | 0 | **=B-C-D<br>553,691** | 203,058 | **=G-H<br>350,633** | **=I/G<br>63.33%** |
| 总表 | 0 | 0 | 253,250 | 505,577 | 265,859 | **=D+E-F<br>492,968** | 507,888 | **=G-H<br>-14,920** | **=I/G<br>-3.03%** |
| 分表 | 0 | 0 | 0 | 0 | 265,859 | **=F<br>265,859** | 292,381 | **=G-H<br>-26,522** | **=I/G<br>-9.97%** |
| **合计:** | | | | | | **=SUM(G:G)<br>1,312,518** | **=SUM(H:H)<br>1,003,327** | **=G合计-H合计<br>309,191** | **=I合计/G合计<br>23.56%** |

---

## ⚠️ 注意事项

### 1. 模拟数据范围
- 数据范围基于9月的真实数据进行估算
- 每次添加时会随机生成，数值略有不同

### 2. 公式自动计算
- Excel会自动计算所有公式
- 打开文件时可能需要启用"自动计算"（通常默认开启）

### 3. 格式继承
- 自动复制9月统计表的格式（字体、颜色、边框、数字格式）
- 确保新表格与原有表格风格一致

### 4. 数据修改
- 生成后可以手动修改任何监控点数据
- 修改后，公式会自动重新计算

---

## 🔧 技术实现

### 使用的公式

```python
# 供水量（3种类型）
row_type1: f"=B{row}-C{row}-D{row}"
row_type2: f"=D{row}+E{row}-F{row}"
row_type3: f"=F{row}"

# 损耗水量
f"=G{row}-H{row}"

# 水损耗率
f"=I{row}/G{row}"

# 合计行
供水量: f"=SUM(G{start}:G{end})"
售水量: f"=SUM(H{start}:H{end})"
损耗水量: f"=G{total_row}-H{total_row}"
水损耗率: f"=I{total_row}/G{total_row}"
```

### 模拟数据生成

```python
import random

# 第1行数据范围
b_val = random.randint(4200000, 4300000)
c_val = random.randint(3400000, 3500000)
d_val = random.randint(250000, 260000)
sale_val = random.randint(200000, 210000)

# 第2行数据范围
d_val = random.randint(250000, 260000)
e_val = random.randint(500000, 510000)
f_val = random.randint(260000, 270000)
sale_val = random.randint(500000, 510000)

# 第3行数据范围
f_val = random.randint(260000, 270000)
sale_val = random.randint(290000, 295000)
```

---

## 📊 数据质量检查

### 正常水损耗率范围
- ✅ **3-10%**: 优秀，管网损耗低
- ✅ **10-20%**: 良好，正常损耗
- ⚠️ **20-30%**: 较高，可能有漏水
- ❌ **>30%**: 异常高，需要检查
- ❌ **负值**: 异常，售水量大于供水量

### 可能的异常原因
1. **负损耗率**: 统计口径不同，或数据错误
2. **过高损耗率**: 管网漏水、计量误差
3. **数据为0**: 监控点设备故障

---

## 🚀 下一步优化建议

### 短期
- [ ] 添加数据校验功能
- [ ] 异常值检测和提示
- [ ] 导出数据质量报告

### 中期
- [ ] 从月度明细表自动提取真实数据
- [ ] 支持自定义数据范围
- [ ] 历史数据对比分析

### 长期
- [ ] 机器学习预测供水量
- [ ] 智能识别异常模式
- [ ] 自动生成分析报告

---

**更新时间**: 2025-10-17  
**版本**: v2.0  
**作者**: Claude Code Assistant


