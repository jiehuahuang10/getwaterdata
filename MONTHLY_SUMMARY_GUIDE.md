# 每月自动添加统计表功能说明

## 📋 功能概述

每月1号自动在"石滩区分区计量.xlsx"的上个月工作表底部添加新的统计表。

例如：
- 10月1日 → 在"石滩2025年9月"工作表底部添加"石滩10月分区计量统计"
- 11月1日 → 在"石滩2025年10月"工作表底部添加"石滩11月分区计量统计"

---

## ✅ 已完成功能

### 1. 自动添加完整统计表

添加的内容包括：

#### 上半部分（分区统计）
- 标题行：石滩X月分区计量统计
- 时间行：数据时间、数据读取值时间
- 表头行：售水量、供水量、损耗水量、水损耗(百分比)
- 数据行：荔城、嘉园、石滩（3行）
- 合计行

#### 下半部分（监控表供水量）
- 分隔行：监控表供水量
- 表头行：荔新大道、宁西总表、如丰大道、新城大道医院NB、三樵仔、供水量、售水量、损耗水量、水损耗
- 数据行：1区、2区、3区（3行）

### 2. 格式完全一致

- ✅ 字体样式（宋体、大小、粗体）
- ✅ 对齐方式（居中、左对齐）
- ✅ 边框样式
- ✅ 填充颜色
- ✅ 数字格式
- ✅ 合并单元格

### 3. 智能检测

- ✅ 自动识别上个月的工作表
- ✅ 检测是否已添加（避免重复）
- ✅ 仅在每月1号执行

---

## 🚀 使用方法

### 方法1: 手动执行（测试）

```bash
# 测试添加统计表（不管是否1号）
python auto_add_monthly_summary.py --force
```

### 方法2: 定时自动执行（推荐）

#### 使用GitHub Actions

已配置好的工作流：`.github/workflows/monthly-summary.yml`

- **执行时间**: 每月1号早上8点（北京时间）
- **自动提交**: 添加后自动提交到GitHub
- **手动触发**: 可以在GitHub Actions页面手动运行

#### 使用Windows计划任务

1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：每月1号
4. 操作：启动程序
   ```
   程序：python
   参数：D:\pj\getwaterdata\auto_add_monthly_summary.py
   起始于：D:\pj\getwaterdata
   ```

#### 使用Linux Cron

```bash
# 编辑crontab
crontab -e

# 添加以下行（每月1号早上8点执行）
0 8 1 * * cd /path/to/getwaterdata && python auto_add_monthly_summary.py
```

---

## 📊 效果演示

### 添加前（9月工作表）
```
第1行：空
第2行：石滩9月分区计量统计
...
第11行：合计行
...
第28行：最后一行数据
```

### 添加后（9月工作表）
```
第1行：空
第2行：石滩9月分区计量统计
...
第11行：合计行（原有）
...
第28行：最后一行数据（原有）
第29行：空行
第30行：石滩10月分区计量统计 ← 新添加
第31行：空
第32行：数据时间
第33行：数据读取值时间
第34行：空
第35行：表头（售水量、供水量...）
第36行：荔城 | 0 | 0 | 0 | 0
第37行：嘉园 | 0 | 0 | 0 | 0
第38行：石滩 | 0 | 0 | 0 | 0
第39行：合计 | 0 | 0 | 0 | 0
第40行：空
第41行：空
第42行：空
第43行：监控表供水量
第44行：表头（荔新大道、宁西总表...）
第45行：1区 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0
第46行：2区 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0
第47行：3区 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0
```

---

## 🔧 文件说明

### 核心文件

1. **`auto_add_monthly_summary.py`** - 主程序
   - 自动识别月份
   - 添加统计表
   - 检测重复

2. **`.github/workflows/monthly-summary.yml`** - GitHub Actions配置
   - 定时执行
   - 自动提交

3. **`add_monthly_summary_final.py`** - 测试脚本
   - 用于开发测试
   - 保存到新文件

### 测试文件

- `test_add_summary.py` - 基础测试
- `test_add_summary_safe.py` - 安全分析
- `analyze_september_sheet.py` - 表格分析

---

## ⚠️ 注意事项

### 1. 文件占用问题

**问题**: 如果Excel文件正在被打开，程序无法保存。

**解决**:
- 关闭Excel文件后再运行
- 或使用GitHub Actions（服务器上没有文件占用）

### 2. 工作表名称

程序会自动查找工作表，格式为：`石滩{年}年{月}月`

例如：
- `石滩2025年9月`
- `石滩2025年10月`

如果工作表不存在，程序会跳过。

### 3. 重复添加检测

程序会检查最后10行是否已存在相同标题的统计表，避免重复添加。

如果检测到重复，会输出：
```
[WARN] 检测到已存在相同标题的统计表（第X行）
[WARN] 跳过添加，避免重复
```

### 4. 数据初始值

新添加的统计表所有数据初始化为 `0`，需要后续手动或自动填充。

---

## 📈 下一步计划

### 阶段1: 基础功能（已完成✅）
- ✅ 自动添加统计表结构
- ✅ 复制格式和样式
- ✅ 智能检测月份
- ✅ 避免重复添加

### 阶段2: 数据填充（待实现）
- ⏳ 根据您的需求自动计算数据
- ⏳ 从其他数据源读取
- ⏳ 自动填充到统计表

### 阶段3: 高级功能（待实现）
- ⏳ 数据验证
- ⏳ 异常检测
- ⏳ 报表生成

---

## 💬 使用示例

### 示例1: 测试添加

```bash
# 1. 先查看当前效果
python analyze_september_sheet.py

# 2. 测试添加（保存到新文件）
python add_monthly_summary_final.py

# 3. 打开新文件查看
# excel_exports/石滩区分区计量_已添加统计表.xlsx

# 4. 确认无误后，正式添加
python auto_add_monthly_summary.py --force
```

### 示例2: 配置GitHub Actions

```bash
# 1. 提交代码到GitHub
git add .
git commit -m "添加每月自动统计表功能"
git push

# 2. 在GitHub网站上：
#    - 进入仓库
#    - 点击 "Actions"
#    - 找到 "每月添加统计表"
#    - 点击 "Run workflow" 测试

# 3. 查看执行结果
#    - 查看日志
#    - 检查是否有新的commit
#    - 下载更新后的Excel文件
```

---

## 🎯 总结

### 当前状态
✅ **功能已完全实现！**

- 可以在每月1号自动添加统计表
- 格式和样式完全一致
- 支持手动和自动执行
- 已配置GitHub Actions

### 下一步
等待您的需求，实现数据自动填充功能！

---

**如有任何问题或需要调整，请随时告诉我！** 🚀

