# 飞书文档自动同步方案

## 📋 方案概述

实现 GitHub 自动更新到飞书云文档的功能，每天定时将 `石滩供水服务部每日总供水情况.xlsx` 同步到飞书。

---

## 🎯 功能目标

### 实现效果
```
每天下午6点 GitHub Actions 运行
    ↓
更新本地 Excel 文件
    ↓
提交到 GitHub
    ↓
自动上传到飞书云文档
    ↓
飞书文档自动更新
```

### 支持的操作
- ✅ 自动上传 Excel 到飞书
- ✅ 覆盖更新飞书已有文件
- ✅ 保持文件格式和内容
- ✅ 支持多人在线查看
- ✅ 失败自动重试

---

## 🔧 技术方案

### 方案一：飞书开放平台 API（推荐）

**优点**:
- 官方支持，稳定可靠
- 功能完整，API丰富
- 支持文件上传、更新、权限管理

**缺点**:
- 需要创建企业自建应用
- 需要管理员权限审批

**适用场景**: 企业正式使用，长期维护

---

### 方案二：飞书网盘 Webhook

**优点**:
- 配置简单
- 无需复杂权限

**缺点**:
- 功能有限
- 可能不支持直接更新文件

**适用场景**: 快速测试，临时使用

---

## 📝 需要准备的信息

### 1. 飞书账号信息

#### 必需信息
- [ ] **飞书企业名称**: _________________
- [ ] **管理员账号**: _________________
- [ ] **是否有管理员权限**: 是 / 否

#### 说明
- 需要企业管理员权限才能创建应用
- 如果没有管理员权限，需要联系管理员协助

---

### 2. 飞书应用配置（方案一）

#### 需要创建的内容
1. **企业自建应用**
   - 应用名称：`水务数据自动同步`
   - 应用描述：自动同步水务数据到飞书
   - 应用图标：可选

2. **应用权限**（需要申请）
   ```
   文档相关权限:
   - docs:read (查看云文档)
   - docs:write (编辑和移除云文档)
   - drive:drive (访问知识库)
   
   文件上传权限:
   - bitable:app (查看、评论和编辑多维表格)
   - docx:document (查看、评论和编辑文档)
   ```

3. **获取凭证**
   - [ ] **App ID**: _________________
   - [ ] **App Secret**: _________________

#### 获取步骤
```
1. 登录飞书开放平台
   https://open.feishu.cn/

2. 进入"开发者后台" → "创建企业自建应用"

3. 填写应用信息
   - 应用名称
   - 应用描述
   - 上传应用图标

4. 添加应用能力 → "云文档"

5. 添加权限范围
   - 选择所需权限
   - 提交权限申请

6. 获取凭证
   - 复制 App ID
   - 复制 App Secret
   - 妥善保存（不要泄露）

7. 发布应用
   - 创建版本
   - 申请发布
   - 等待管理员审批
```

---

### 3. 飞书目标文件夹

#### 需要提供
- [ ] **目标文件夹路径**: _________________
  - 示例：`/团队空间/水务部门/数据报表/`
  
- [ ] **文件夹 ID**（可选，如果有）: _________________

- [ ] **共享权限设置**:
  - [ ] 仅限指定成员查看
  - [ ] 部门内成员可查看
  - [ ] 全公司可查看

#### 获取文件夹信息
```
1. 在飞书云文档中打开目标文件夹

2. 点击右上角"分享"按钮

3. 复制链接，从链接中提取文件夹ID
   示例链接: https://company.feishu.cn/drive/folder/fldcnXXXXXXXXXXXXXXXXX
   文件夹ID: fldcnXXXXXXXXXXXXXXXXX

4. 或者记录文件夹的完整路径
```

---

### 4. 现有文件信息（如果飞书已有文件）

- [ ] **现有文件名**: _________________
- [ ] **文件链接**: _________________
- [ ] **文件 ID**: _________________
- [ ] **是否需要保留历史版本**: 是 / 否

---

## 💰 成本评估

### 免费方案
- 飞书开放平台 API：完全免费
- GitHub Actions：每月 2000 分钟免费额度
- **总成本**: ¥0

### 时间成本
- 配置飞书应用：30-60 分钟
- 开发集成代码：2-3 小时
- 测试和调试：1-2 小时
- **总时间**: 约 4-6 小时

---

## 🔐 安全说明

### 数据安全
1. **API凭证管理**
   - App Secret 存储在 GitHub Secrets
   - 不会出现在代码中
   - 传输过程加密

2. **访问权限控制**
   - 只能访问指定文件夹
   - 需要明确授权的权限
   - 可随时撤销应用权限

3. **审计日志**
   - 飞书会记录所有 API 操作
   - GitHub Actions 有完整执行日志
   - 可追溯所有操作

---

## 📊 实现流程

### 阶段一：准备工作（1-2天）
```
1. 创建飞书企业自建应用
   ↓
2. 申请所需权限
   ↓
3. 等待管理员审批
   ↓
4. 获取 App ID 和 App Secret
```

### 阶段二：开发集成（1天）
```
1. 编写飞书 API 调用代码
   ↓
2. 实现文件上传功能
   ↓
3. 集成到 GitHub Actions
   ↓
4. 配置环境变量
```

### 阶段三：测试验证（半天）
```
1. 本地测试上传功能
   ↓
2. GitHub Actions 测试
   ↓
3. 验证飞书文件更新
   ↓
4. 测试失败重试机制
```

### 阶段四：正式上线（即时）
```
1. 启用自动同步
   ↓
2. 监控执行日志
   ↓
3. 确认正常运行
```

---

## 🔄 技术实现细节

### GitHub Actions 工作流
```yaml
name: 同步到飞书

on:
  schedule:
    - cron: '0 10 * * *'  # 每天18:00
  workflow_dispatch:

jobs:
  sync-to-feishu:
    runs-on: ubuntu-latest
    steps:
      - name: 更新Excel
        run: python github_automation.py
        
      - name: 上传到飞书
        run: python feishu_sync.py
        env:
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_FOLDER_ID: ${{ secrets.FEISHU_FOLDER_ID }}
```

### Python 飞书 SDK
```python
# 使用官方 SDK
pip install lark-oapi

# 或使用 requests 直接调用 API
import requests

# 1. 获取 access_token
# 2. 上传文件到飞书
# 3. 更新文件到指定位置
```

### API 调用流程
```
1. 获取 tenant_access_token
   POST https://open.feishu.cn/open-api/auth/v3/tenant_access_token/internal/

2. 上传文件
   POST https://open.feishu.cn/open-api/drive/v1/files/upload_all

3. 移动文件到目标文件夹（如需要）
   POST https://open.feishu.cn/open-api/drive/v1/files/{file_token}/move

4. 更新权限（如需要）
   POST https://open.feishu.cn/open-api/drive/v1/permissions/{token}/members
```

---

## ⚠️ 注意事项

### 1. 飞书应用审批
- 需要企业管理员审批
- 审批可能需要 1-3 个工作日
- 建议提前申请

### 2. 权限范围
- 只申请必需的权限
- 权限过多可能审批不通过
- 可后续追加权限

### 3. 文件大小限制
- 飞书单个文件上传限制：20MB
- 当前 Excel 文件约 500KB
- 完全满足需求

### 4. API 调用限制
- 飞书 API 有频率限制
- 每天一次调用完全没问题
- 需要处理 API 错误重试

### 5. 文件版本管理
- 飞书会自动保存历史版本
- 可随时恢复到之前版本
- 版本保留时间根据企业套餐

---

## 🆚 方案对比

| 对比项 | 当前方案（仅GitHub） | 飞书同步方案 |
|--------|---------------------|--------------|
| 访问便利性 | 需要登录GitHub | 飞书内直接查看 |
| 手机查看 | 需要下载GitHub App | 飞书App直接查看 |
| 协作功能 | 有限 | 强大（评论、分享） |
| 权限管理 | GitHub权限 | 飞书权限（更灵活） |
| 数据备份 | GitHub | GitHub + 飞书双备份 |
| 配置复杂度 | 简单 | 中等 |
| 维护成本 | 低 | 中等 |

---

## 📱 用户体验提升

### 使用飞书后的优势

#### 1. 移动端友好
```
飞书App → 云文档 → 水务报表 → 查看最新数据
无需下载，实时查看
```

#### 2. 多人协作
```
- 添加评论和批注
- @同事讨论数据
- 分享给外部合作方
- 设置只读/编辑权限
```

#### 3. 通知提醒
```
- 文件更新自动通知相关人员
- 可订阅文件夹更新
- 支持群聊通知
```

#### 4. 在线预览
```
- 无需下载即可查看
- 支持筛选、排序
- 可导出为 PDF
```

---

## 🚀 扩展功能

### 未来可实现的功能

1. **自动生成报表**
   - 每日数据汇总表
   - 每周趋势图表
   - 每月统计报告

2. **数据异常预警**
   - 数据异常自动通知
   - 飞书机器人推送
   - @相关负责人

3. **多文件同步**
   - 同步月度统计表
   - 同步其他数据文件
   - 建立完整文档体系

4. **权限精细化**
   - 不同部门不同权限
   - 数据脱敏显示
   - 审计日志

---

## ✅ 决策检查清单

在决定是否实施前，请确认：

### 必要性评估
- [ ] 是否需要在飞书中频繁查看数据？
- [ ] 是否需要多人协作查看？
- [ ] 是否需要移动端便捷访问？
- [ ] 当前的 GitHub 方式是否不够方便？

### 可行性评估
- [ ] 是否有飞书企业账号？
- [ ] 是否能获得管理员权限？
- [ ] 是否愿意花时间配置和维护？
- [ ] 团队成员是否都使用飞书？

### 时间和精力
- [ ] 是否愿意投入 4-6 小时配置？
- [ ] 是否能接受 1-3 天的审批等待？
- [ ] 是否有人负责后续维护？

---

## 📞 下一步行动

### 如果决定实施

1. **收集信息**（按本文档清单）
   - 飞书账号信息
   - 管理员联系方式
   - 目标文件夹路径

2. **提供给我**
   ```
   请提供：
   - FEISHU_APP_ID
   - FEISHU_APP_SECRET
   - FEISHU_FOLDER_ID（或文件夹路径）
   - 目标文件名
   ```

3. **开始开发**
   - 我会编写集成代码
   - 配置 GitHub Actions
   - 进行测试验证

### 如果暂不实施

- 可以随时回来启动这个功能
- 当前的 GitHub 方式继续正常工作
- 不影响现有任何功能

---

## 📚 参考资源

### 飞书开放平台文档
- 官网：https://open.feishu.cn/
- API文档：https://open.feishu.cn/document/
- SDK下载：https://open.feishu.cn/document/ukTMukTMukTM/uYjN1YjL2YTN24iN2UjN

### 相关教程
- 企业自建应用创建：https://open.feishu.cn/document/home/introduction-to-custom-app-development/self-built-application-development-process
- 文件上传 API：https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/drive-v1/file/upload_all

---

## 💬 常见问题

### Q: 飞书同步会影响现有的 GitHub 功能吗？
A: 不会。飞书同步是在 GitHub 更新之后的额外步骤，不影响现有功能。

### Q: 如果飞书同步失败怎么办？
A: GitHub 的文件仍然会正常更新，只是飞书没有同步。可以手动下载后上传，或重新运行同步任务。

### Q: 数据会不会泄露？
A: 不会。API 凭证加密存储，只有授权的应用可以访问，且有完整的审计日志。

### Q: 可以只同步给特定的人吗？
A: 可以。通过飞书的权限管理，可以精确控制谁能访问文件。

### Q: 需要额外付费吗？
A: 不需要。飞书开放平台 API 免费，GitHub Actions 在免费额度内。

---

**文档版本**: v1.0  
**创建日期**: 2025-10-25  
**作者**: AI助手  
**适用项目**: 石滩供水数据管理系统

