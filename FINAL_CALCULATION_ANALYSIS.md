# 石滩区分区计量表格 - 数据计算深度分析报告

**分析日期**: 2025-10-17  
**文件**: excel_exports/石滩区分区计量.xlsx

---

## 📊 一、表格结构概述

### 1.1 工作表组成

共 **13个工作表**：

1. **主表**: `石滩区` (79行 × 20列) - 汇总所有月度统计
2. **月度明细表** (12个):
   - 石滩2025年2月-9月 (8个)
   - 三江2025年6月-9月 (4个)

### 1.2 主表（石滩区）结构

主表包含**多个月度统计表**，按时间顺序排列：

```
┌─────────────────────────────────────┐
│ 2025年2月 (第9行)                   │
│ 2025年3月 (第16行)                  │
│ 2025年4月 (第23行)                  │
│ 2025年5月 (第30行)                  │
│ 2025年6月 (第37行)                  │
│ 2025年7月 (第44行)                  │
│ 2025年8月 (第51行)                  │
│ 2025年9月 (第58行)   ← 真实数据     │
│ 2025年10月 (第67行)  ← 新添加的     │
│ 2025年11月 (第74行)  ← 测试添加的   │
└─────────────────────────────────────┘
```

每个月度统计表的结构：

```
行N:     45901              (Excel日期序列号，显示为"2025年9月")
行N+1:   监控表供水量 | ... | 总计统计
行N+2:   荔新大道 | 宁西总表 | ... | 供水量 | 售水量 | 损耗水量 | 水损耗(%)
行N+3:   总表      [数据行1] → 有公式
行N+4:   总表      [数据行2] → 有公式
行N+5:   分表      [数据行3] → 有公式
行N+6:   合计：    [总计行] → SUM公式
```

---

## 📋 二、数据列详解

### 2.1 监控点列（原始数据输入）

| 列 | 列名 | 说明 | 数据类型 |
|---|---|---|---|
| **A** | (日期/标签) | 总表/分表/合计 | 文本 |
| **B** | 荔新大道 | 监控点1 | 数值 |
| **C** | 宁西总表（插入式）DN1200 | 监控点2 | 数值 |
| **D** | 如丰大道 | 监控点3 | 数值 |
| **E** | 新城大道医院NB | 监控点4 | 数值 |
| **F** | 三棵竹 | 监控点5 | 数值 |

### 2.2 汇总计算列（公式列）

| 列 | 列名 | 计算逻辑 | 公式示例 |
|---|---|---|---|
| **G** | 供水量 | 根据监控点数据计算 | 见下文 |
| **H** | 售水量 | 手动输入 | 无公式 |
| **I** | 损耗水量 | 供水量 - 售水量 | `=G61-H61` |
| **J** | 水损耗（百分比） | 损耗水量 / 供水量 | `=I61/G61` |

---

## 🧮 三、关键计算公式详解

### 3.1 供水量（列G）的计算逻辑

根据9月数据分析，**供水量的计算方式因行而异**：

#### **第1行数据（总表）**
```
公式: =B61-C61-D61
逻辑: 荔新大道 - 宁西总表 - 如丰大道
说明: 总表数据通过差值计算
```

#### **第2行数据（总表）**
```
公式: =D62+E62-F62
逻辑: 如丰大道 + 新城大道医院NB - 三棵竹
说明: 可能是不同区域的加减运算
```

#### **第3行数据（分表）**
```
公式: =F63
逻辑: 直接引用三棵竹的值
说明: 分表直接取某个监控点的值
```

#### **总计行**
```
公式: =SUM(G61:G63)
逻辑: 对所有数据行的供水量求和
说明: 月度总供水量
```

### 3.2 损耗水量（列I）的计算

**适用于所有行（数据行和总计行）**：

```
公式: =G行号-H行号
示例: =G61-H61  (第61行)
      =G64-H64  (总计行)
```

**计算逻辑**：
```
损耗水量 = 供水量 - 售水量
```

### 3.3 水损耗百分比（列J）的计算

**适用于所有行（数据行和总计行）**：

```
公式: =I行号/G行号
示例: =I61/G61  (第61行)
      =I64/G64  (总计行)
```

**计算逻辑**：
```
水损耗率 = 损耗水量 / 供水量
```

**显示格式**: 百分比（如 0.15 显示为 15%）

---

## 🔄 四、数据流向和计算顺序

```
步骤1: 输入监控点原始数据
┌────────────────────────────────────┐
│ B列: 荔新大道        = 4264205     │
│ C列: 宁西总表        = 3457264     │
│ D列: 如丰大道        = 253250      │
│ E列: 新城大道医院NB  = 505577      │
│ F列: 三棵竹          = 265859      │
└──────────┬─────────────────────────┘
           ↓
步骤2: 计算供水量（根据行类型不同公式不同）
┌────────────────────────────────────┐
│ G列: 供水量                        │
│  - 总表行1: =B-C-D  = 553691      │
│  - 总表行2: =D+E-F  = 492968      │
│  - 分表行3: =F      = 265859      │
└──────────┬─────────────────────────┘
           ↓
步骤3: 输入售水量
┌────────────────────────────────────┐
│ H列: 售水量        = 223896        │
│                    = 550454        │
│                    = 256399        │
└──────────┬─────────────────────────┘
           ↓
步骤4: 计算损耗水量
┌────────────────────────────────────┐
│ I列: 损耗水量 = G列 - H列          │
│  = 553691 - 223896 = 329795        │
│  = 492968 - 550454 = -57486        │
│  = 265859 - 256399 = 9460          │
└──────────┬─────────────────────────┘
           ↓
步骤5: 计算水损耗率
┌────────────────────────────────────┐
│ J列: 水损耗率 = I列 / G列          │
│  = 329795 / 553691 = 59.55%        │
│  = -57486 / 492968 = -11.66%       │
│  = 9460 / 265859 = 3.56%           │
└──────────┬─────────────────────────┘
           ↓
步骤6: 计算总计
┌────────────────────────────────────┐
│ 合计行:                            │
│  G: =SUM(G61:G63) = 1312518        │
│  H: =SUM(H61:H63) = 1030749        │
│  I: =G64-H64      = 281769         │
│  J: =I64/G64      = 21.46%         │
└────────────────────────────────────┘
```

---

## 💡 五、业务逻辑推断

### 5.1 三种供水类型

根据公式分析，石滩区的供水计量分为三种类型：

1. **总表类型1（差值法）**
   - 公式: `B - C - D`
   - 含义: 可能表示某个大区域减去子区域的供水量
   - 例如: 荔新大道总量 - 宁西分表 - 如丰分表 = 剩余供水量

2. **总表类型2（加减法）**
   - 公式: `D + E - F`
   - 含义: 可能是两个供水源相加，减去一个分表
   - 例如: 如丰大道 + 新城大道 - 三棵竹分表 = 某区域供水量

3. **分表类型（直接引用）**
   - 公式: `=F`
   - 含义: 直接使用某个监控点的数据
   - 例如: 三棵竹分表独立计量

### 5.2 水损耗率的意义

**正常范围**: 3% - 25%
- **3-10%**: 优秀，管网损耗低
- **10-20%**: 良好，正常损耗
- **20-30%**: 较高，可能有漏水
- **负值**: 异常，售水量大于供水量（可能是统计口径不同）

从9月数据看：
- 分表（3.56%）: 优秀
- 总表2（-11.66%）: 异常负值
- 总表1（59.55%）: 偏高，可能需要检查

---

## 🎯 六、自动化实现现状

### 6.1 已实现功能 ✅

1. **自动添加月度统计表结构**
   - ✅ 自动识别最后一个月份
   - ✅ 自动计算下一个月份
   - ✅ 添加月份标题行
   - ✅ 添加表头行（包括监控点名称）
   - ✅ 初始化数据行（1日-31日）
   - ✅ 添加总计行

2. **格式和样式复制**
   - ✅ 复制单元格字体
   - ✅ 复制对齐方式
   - ✅ 复制背景颜色
   - ✅ 复制边框样式

3. **Web界面**
   - ✅ 手动触发添加
   - ✅ 支持添加下1个月/下2个月
   - ✅ 实时显示当前状态

### 6.2 待实现功能 ⏳

1. **数据自动填充**
   - ⏳ 从月度明细表自动提取监控点数据
   - ⏳ 自动填充B-F列的原始数据
   - ⏳ 自动填充H列的售水量数据

2. **公式自动生成**
   - ⏳ 为G列（供水量）自动添加公式
   - ⏳ 为I列（损耗水量）自动添加公式 `=G-H`
   - ⏳ 为J列（水损耗率）自动添加公式 `=I/G`
   - ⏳ 为总计行自动添加SUM公式

3. **智能计算**
   - ⏳ 自动识别行类型（总表1/总表2/分表）
   - ⏳ 根据行类型应用不同的供水量计算公式
   - ⏳ 自动判断日期范围（处理不同月份的天数）

4. **数据校验**
   - ⏳ 检查监控点数据完整性
   - ⏳ 检查计算结果合理性
   - ⏳ 检测异常水损耗率（负值或过高）
   - ⏳ 自动生成数据质量报告

---

## 📝 七、实现建议

### 7.1 短期目标（公式自动生成）

**优先级**: 高  
**难度**: 中

**实现步骤**:
1. 在`add_summary_web.py`中添加公式生成逻辑
2. 为每个数据行添加：
   ```python
   # 损耗水量公式
   ws.cell(row, 9).value = f"=G{row}-H{row}"
   
   # 水损耗率公式
   ws.cell(row, 10).value = f"=I{row}/G{row}"
   ```
3. 为总计行添加：
   ```python
   # 供水量总计
   ws.cell(total_row, 7).value = f"=SUM(G{start}:G{end})"
   
   # 售水量总计
   ws.cell(total_row, 8).value = f"=SUM(H{start}:H{end})"
   
   # 损耗水量总计
   ws.cell(total_row, 9).value = f"=G{total_row}-H{total_row}"
   
   # 水损耗率总计
   ws.cell(total_row, 10).value = f"=I{total_row}/G{total_row}"
   ```

### 7.2 中期目标（数据自动填充）

**优先级**: 中  
**难度**: 高

**实现思路**:
1. 创建或读取对应月份的明细表（如"石滩2025年10月"）
2. 从明细表中提取每日数据
3. 填充到主表对应行

**挑战**:
- 需要知道明细表的具体结构
- 需要建立明细表和主表的字段映射关系

### 7.3 长期目标（智能计算）

**优先级**: 低  
**难度**: 很高

**实现思路**:
1. 分析历史数据，识别每行的计算规则
2. 使用机器学习或规则引擎自动推断公式
3. 根据行标签（总表/分表）自动应用不同公式

**挑战**:
- 业务规则复杂，可能需要人工配置
- 不同月份可能有不同的计算规则

---

## 🔍 八、关键发现

1. ⚠️ **表头名称已修正**:
   - 已将"三樵仔"改为"三棵竹"

2. 📅 **日期格式混合**:
   - 旧的月份标题: Excel日期序列号（45901）
   - 新添加的月份: 文本格式（"2025年10月"）
   - 建议: 统一为文本格式，便于阅读

3. 🧮 **公式复杂性**:
   - 供水量计算不是简单的求和
   - 每行有不同的计算逻辑
   - 需要根据行类型应用不同公式

4. ⚡ **数据完整性**:
   - 新添加的表格初始值为0
   - 无公式，需要手动填写或自动生成
   - 建议优先实现公式自动生成

---

## 📊 九、总结

### 核心计算关系

```
监控点数据(B-F) → 供水量(G) → 损耗水量(I) → 水损耗率(J)
                        ↑           ↑
                    公式计算    售水量(H)
```

### 自动化价值

1. **节省时间**: 每月手动添加统计表需要30分钟，自动化后仅需3秒
2. **减少错误**: 避免公式输入错误
3. **统一格式**: 确保所有月份的表格格式一致

### 下一步计划

- [ ] 实现公式自动生成（损耗水量、水损耗率、总计行）
- [ ] 创建测试案例验证公式正确性
- [ ] 优化Web界面，显示更多信息
- [ ] 添加数据校验功能

---

*报告生成时间: 2025-10-17*  
*分析工具: Python + openpyxl*  
*Claude Code 自动分析系统*

