# 数据可用性检查功能说明

## ✅ **已实现：基于数据源的智能检查**

---

## 🎯 **核心逻辑**

系统不再检查系统当前日期，而是**检查数据源文件中是否有完整数据**。

### **检查规则**

要添加某个月份（例如10月）的统计表，系统会：

1. **计算需要的起始日期**
   - 10月数据 = 9月25日 - 10月24日
   - 所以需要检查：**9月25日**的数据是否存在

2. **在数据源中查找该日期**
   - 文件：`石滩供水服务部每日总供水情况.xlsx`
   - 工作表：第3个（石滩区供水数据）
   - 查找：2025-09-25这一行

3. **检查数据是否有效**
   - 检查监控点列（荔新大道、宁西2总表等）
   - 如果有**任何非零值** → 数据有效 ✅
   - 如果**全部为0或空** → 数据无效 ❌

4. **返回结果**
   - 数据有效 → 允许添加
   - 数据无效 → 拒绝并提示

---

## 📊 **实际测试结果**

### **测试1：添加10月统计表（从9月）**

**检查日期**：2025-09-25  
**数据源状态**：
```
Row 2860: 2025-09-25
  荔新大道: 138,265    ✅ 有数据
  宁西2总表: 111,575    ✅ 有数据
  如丰大道: 8,574.79    ✅ 有数据
```

**结果**：✅ **允许添加**（如果9月是最后一个月）

---

### **测试2：添加2026年3月统计表**

**检查日期**：2026-02-25  
**数据源状态**：
```
Row 3013: 2026-02-25
  荔新大道: None       ❌ 无数据
  宁西2总表: None       ❌ 无数据
  如丰大道: None       ❌ 无数据
```

**结果**：❌ **拒绝添加**

**提示信息**：
```
[提示] 数据源暂无完整数据！

目标月份：2026年3月
需要数据：2026年02月25日起的完整数据

数据源文件中尚未更新到该日期，或该日期数据为空。
请等待数据源更新后再添加统计表。
```

---

## 🔍 **当前Excel状态**

### **主表中已有的月份**

| 行号 | 月份 | 状态 |
|-----|------|------|
| 51 | 2025年8月 | ✅ 已添加 |
| 58 | 2025年9月 | ✅ 已添加 |
| 67 | 2025年10月 | ✅ 已添加 |
| 74 | 2025年11月 | ✅ 已添加 |
| 81 | 2025年12月 | ✅ 已添加 |
| 88 | 2026年1月 | ✅ 已添加 |
| 95 | 2026年2月 | ✅ 已添加 |

**下一个要添加**：2026年3月

---

## 💻 **技术实现**

### **代码逻辑**

```python
def add_monthly_summary_to_main(month_offset=1, use_real_data=False):
    # 1. 确定目标月份（例如：2026年3月）
    target_month = ...
    target_year = ...
    
    # 2. 计算需要的起始日期（2026年2月25日）
    if target_month == 1:
        required_start_date = datetime(target_year - 1, 12, 25)
    else:
        required_start_date = datetime(target_year, target_month - 1, 25)
    
    # 3. 打开数据源文件
    wb_data = openpyxl.load_workbook("石滩供水服务部每日总供水情况.xlsx")
    ws_data = wb_data.worksheets[2]
    
    # 4. 查找该日期并检查数据
    has_required_data = False
    for row in range(5, ws_data.max_row + 1):
        date_val = ws_data.cell(row, 1).value
        if date_val == required_start_date:
            # 检查监控点列是否有非零数据
            for col in [7, 12, 14, 8, 15]:  # 荔新、宁西、如丰等
                val = ws_data.cell(row, col).value
                if val and val != 0:
                    has_required_data = True
                    break
            break
    
    # 5. 判断是否允许添加
    if not has_required_data:
        return {"success": False, "message": "数据源暂无完整数据！"}
    
    # 6. 继续添加统计表...
```

### **关键检查列**

| 列号 | 监控点名称 |
|-----|----------|
| 7 | 荔新大道 |
| 12 | 宁西2总表 |
| 14 | 如丰大道600监控表 |
| 8 | 新城大道医院NB |
| 15 | 三棵树600监控表 |

只要**任意一列**有非零值，就认为数据有效。

---

## 🎯 **使用场景**

### **场景1：正常添加（数据已更新）**

**时间**：10月25日  
**操作**：添加10月统计表  
**检查**：9月25日数据 ✅ 存在  
**结果**：✅ 成功添加

---

### **场景2：数据未更新（拒绝添加）**

**时间**：任何时间  
**操作**：添加2026年3月统计表  
**检查**：2026年2月25日数据 ❌ 不存在/为空  
**结果**：❌ 拒绝添加，显示提示

---

### **场景3：数据源延迟更新**

**情况**：今天是10月28日，但数据源只更新到10月20日  
**操作**：添加10月统计表  
**检查**：9月25日数据 ✅ 存在  
**结果**：✅ 允许添加  
**注意**：虽然允许添加，但10月21-24日的数据可能是0，导致统计不完整

---

## ⚠️ **注意事项**

### **1. 数据完整性**

系统只检查**起始日期（上月25日）**是否有数据，不检查**结束日期（本月24日）**。

这意味着：
- ✅ 如果9月25日有数据 → 允许添加10月
- ⚠️ 但如果10月24日数据还没更新 → 统计表会不完整

**建议**：
- 在每月25日或之后添加
- 确认数据源已更新完整后再添加

### **2. 降级策略**

如果检查数据源失败（例如文件不存在），系统会：
- 打印警告信息
- **继续执行**（降级到模拟数据）

### **3. use_real_data参数**

只有当 `use_real_data=True` 时才进行检查。

如果 `use_real_data=False`（模拟数据模式），则**跳过检查**，直接添加。

---

## 📝 **与之前的区别**

### **之前的方案（已废弃）**
```
检查：系统当前日期是否 >= 25日
问题：不管数据源是否有数据，只看日期
```

### **当前方案（已实现）**
```
检查：数据源中是否有目标月份的起始数据
优点：真正基于数据可用性，而不是日期
```

---

## 🧪 **测试脚本**

```bash
# 测试数据可用性检查
python test_data_availability.py

# 检查特定日期的数据
python check_925_data.py          # 检查9月25日
python check_2026_feb_data.py     # 检查2026年2月25日
```

---

## 📄 **相关文件**

- `add_summary_web.py` - 主程序（包含数据检查逻辑）
- `test_data_availability.py` - 测试脚本
- `check_925_data.py` - 检查9月25日数据
- `check_2026_feb_data.py` - 检查2026年2月数据

---

## ✅ **总结**

**现在的系统会智能检查**：
1. ✅ 确定要添加的月份
2. ✅ 计算需要的起始日期（上月25日）
3. ✅ 在数据源中查找该日期
4. ✅ 检查是否有有效数据（非零值）
5. ✅ 有数据→允许，无数据→拒绝

**这确保了只有当数据源真正有数据时才能添加统计表！** 🎯

